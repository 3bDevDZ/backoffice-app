name: Python Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libcairo2-dev \
          libgirepository1.0-dev \
          pkg-config \
          python3-dev \
          python3-gi \
          gir1.2-gtk-3.0 \
          meson \
          ninja-build
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install meson-python
        # Try to install all requirements normally first
        # If it fails (e.g., due to pycairo), install packages individually
        pip install -r requirements.txt || python << 'EOF'
        import subprocess
        import sys
        
        print("Standard installation failed, installing packages individually...")
        with open('requirements.txt', 'r') as f:
            packages = [line.strip() for line in f if line.strip() and not line.strip().startswith('#')]
        
        failed = []
        for package in packages:
            print(f"Installing {package}...")
            result = subprocess.run([sys.executable, '-m', 'pip', 'install', package], 
                                  capture_output=True, text=True)
            if result.returncode != 0:
                # Check if it's a critical error or just optional dependency
                if 'pycairo' in package.lower() or 'pycairo' in result.stderr.lower():
                    print(f"Warning: {package} failed (optional dependency, continuing...)")
                else:
                    print(f"Error: Failed to install {package}")
                    failed.append(package)
            else:
                print(f"âœ“ Successfully installed {package}")
        
        if failed:
            print(f"\nError: {len(failed)} critical package(s) failed: {', '.join(failed)}")
            sys.exit(1)
        print("\nInstallation complete.")
        EOF
    
    - name: Run unit tests with coverage
      run: |
        pytest tests/unit/ --cov=app --cov-report=html --cov-report=xml
    
    - name: Run BDD tests
      run: |
        behave tests/bdd/features/
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: htmlcov/

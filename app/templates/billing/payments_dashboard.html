{% extends "base.html" %}

{% block title %}{{ _('Payments Dashboard') }} - CommerceFlow{% endblock %}

{% block extra_css %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
    .kpi-card {
        transition: transform 0.2s;
    }
    .kpi-card:hover {
        transform: translateY(-2px);
    }
    .chart-container {
        position: relative;
        height: 300px;
    }
</style>
{% endblock %}

{% block page_title %}{{ _('Payments Dashboard') }}{% endblock %}
{% block page_subtitle %}{{ _('Outstanding payments overview and analytics') }}{% endblock %}

{% block content %}
<div class="space-y-6">
    {% if total_outstanding == 0.0 and total_overdue_count == 0 %}
    <!-- No Data Message -->
    <div class="bg-white rounded-lg shadow-sm p-12 text-center">
        <i class="fas fa-check-circle text-green-500 text-6xl mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">{{ _('No Outstanding Payments') }}</h3>
        <p class="text-gray-500 mb-4">{{ _('All invoices are paid. Great job!') }}</p>
        <a href="{{ url_for('billing.payments_list') }}" class="inline-block px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
            {{ _('View All Payments') }}
        </a>
    </div>
    {% else %}
    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Total Outstanding -->
        <div class="bg-white rounded-lg shadow-sm p-6 kpi-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">{{ _('Total Outstanding') }}</p>
                    <p class="text-2xl font-bold text-gray-900 mt-2">
                        {{ "%.2f"|format(total_outstanding) }} €
                    </p>
                </div>
                <div class="p-3 bg-blue-100 rounded-full">
                    <i class="fas fa-euro-sign text-blue-600 text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- Total Overdue -->
        <div class="bg-white rounded-lg shadow-sm p-6 kpi-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">{{ _('Total Overdue') }}</p>
                    <p class="text-2xl font-bold text-red-600 mt-2">
                        {{ "%.2f"|format(total_overdue_amount) }} €
                    </p>
                </div>
                <div class="p-3 bg-red-100 rounded-full">
                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- Overdue Count -->
        <div class="bg-white rounded-lg shadow-sm p-6 kpi-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">{{ _('Overdue Invoices') }}</p>
                    <p class="text-2xl font-bold text-gray-900 mt-2">
                        {{ total_overdue_count }}
                    </p>
                </div>
                <div class="p-3 bg-yellow-100 rounded-full">
                    <i class="fas fa-file-invoice text-yellow-600 text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- Average Days Overdue -->
        <div class="bg-white rounded-lg shadow-sm p-6 kpi-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">{{ _('Critical (>90 days)') }}</p>
                    <p class="text-2xl font-bold text-orange-600 mt-2">
                        {{ "%.2f"|format(bucket_90_plus) }} €
                    </p>
                    <p class="text-xs text-gray-500 mt-1">{{ invoice_count_90_plus }} {{ _('invoices') }}</p>
                </div>
                <div class="p-3 bg-orange-100 rounded-full">
                    <i class="fas fa-clock text-orange-600 text-2xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Aging Buckets Summary -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">{{ _('Aging Analysis') }}</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- 0-30 days -->
            <div class="border-l-4 border-green-500 pl-4">
                <p class="text-sm font-medium text-gray-500">{{ _('0-30 Days') }}</p>
                <p class="text-xl font-bold text-gray-900">{{ "%.2f"|format(bucket_0_30) }} €</p>
                <p class="text-xs text-gray-500 mt-1">
                    {{ invoice_count_0_30 }} {{ _('invoices') }} ({{ "%.1f"|format(pct_0_30) }}%)
                </p>
            </div>

            <!-- 31-60 days -->
            <div class="border-l-4 border-yellow-500 pl-4">
                <p class="text-sm font-medium text-gray-500">{{ _('31-60 Days') }}</p>
                <p class="text-xl font-bold text-gray-900">{{ "%.2f"|format(bucket_31_60) }} €</p>
                <p class="text-xs text-gray-500 mt-1">
                    {{ invoice_count_31_60 }} {{ _('invoices') }} ({{ "%.1f"|format(pct_31_60) }}%)
                </p>
            </div>

            <!-- 61-90 days -->
            <div class="border-l-4 border-orange-500 pl-4">
                <p class="text-sm font-medium text-gray-500">{{ _('61-90 Days') }}</p>
                <p class="text-xl font-bold text-gray-900">{{ "%.2f"|format(bucket_61_90) }} €</p>
                <p class="text-xs text-gray-500 mt-1">
                    {{ invoice_count_61_90 }} {{ _('invoices') }} ({{ "%.1f"|format(pct_61_90) }}%)
                </p>
            </div>

            <!-- 90+ days -->
            <div class="border-l-4 border-red-500 pl-4">
                <p class="text-sm font-medium text-gray-500">{{ _('90+ Days') }}</p>
                <p class="text-xl font-bold text-red-600">{{ "%.2f"|format(bucket_90_plus) }} €</p>
                <p class="text-xs text-gray-500 mt-1">
                    {{ invoice_count_90_plus }} {{ _('invoices') }} ({{ "%.1f"|format(pct_90_plus) }}%)
                </p>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Aging Distribution Chart -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">{{ _('Aging Distribution by Amount') }}</h2>
            <div class="chart-container">
                <canvas id="agingChart"></canvas>
            </div>
        </div>

        <!-- Top Customers Chart -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">{{ _('Top 10 Customers by Outstanding') }}</h2>
            <div class="chart-container">
                <canvas id="topCustomersChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Customers Table -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h2 class="text-lg font-semibold text-gray-900">{{ _('Top Customers') }}</h2>
            <a href="{{ url_for('billing.aging_report') }}" class="text-sm text-indigo-600 hover:text-indigo-800">
                {{ _('View Full Report') }} <i class="fas fa-arrow-right {% if direction == 'rtl' %}ml-1{% else %}mr-1{% endif %}"></i>
            </a>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ _('Customer') }}</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">{{ _('Total Outstanding') }}</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">{{ _('0-30 Days') }}</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">{{ _('31-60 Days') }}</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">{{ _('61-90 Days') }}</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">{{ _('90+ Days') }}</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">{{ _('Actions') }}</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% if top_customers %}
                        {% for customer in top_customers %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">
                                    {{ customer.customer_name or customer.customer_code or ('Customer #' + customer.customer_id|string) }}
                                </div>
                                {% if customer.customer_code %}
                                <div class="text-xs text-gray-500">{{ customer.customer_code }}</div>
                                {% endif %}
                            </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-semibold text-gray-900">
                                {{ "%.2f"|format(customer.total_outstanding|to_float) }} €
                            </td>
                            {% if customer.buckets %}
                                {% set bucket_0_30_val = 0.0 %}
                                {% set bucket_31_60_val = 0.0 %}
                                {% set bucket_61_90_val = 0.0 %}
                                {% set bucket_90_plus_val = 0.0 %}
                                {% for bucket in customer.buckets %}
                                    {% if bucket.bucket_name == '0-30' %}
                                        {% set bucket_0_30_val = bucket.total_amount|to_float %}
                                    {% elif bucket.bucket_name == '31-60' %}
                                        {% set bucket_31_60_val = bucket.total_amount|to_float %}
                                    {% elif bucket.bucket_name == '61-90' %}
                                        {% set bucket_61_90_val = bucket.total_amount|to_float %}
                                    {% elif bucket.bucket_name == '90+' %}
                                        {% set bucket_90_plus_val = bucket.total_amount|to_float %}
                                    {% endif %}
                                {% endfor %}
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                                    {{ "%.2f"|format(bucket_0_30_val) }} €
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                                    {{ "%.2f"|format(bucket_31_60_val) }} €
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                                    {{ "%.2f"|format(bucket_61_90_val) }} €
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-red-600 font-semibold">
                                    {{ "%.2f"|format(bucket_90_plus_val) }} €
                                </td>
                            {% else %}
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-400">-</td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-400">-</td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-400">-</td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-400">-</td>
                            {% endif %}
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                                <a href="{{ url_for('billing.aging_report', customer_id=customer.customer_id) }}" 
                                   class="text-indigo-600 hover:text-indigo-900">
                                    {{ _('Details') }}
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">
                                {{ _('No outstanding invoices') }}
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Aging Distribution Chart
const agingCtx = document.getElementById('agingChart').getContext('2d');
const chartLabels = {{ chart_data.labels|tojson|safe }};
const chartAmounts = {{ chart_data.amounts|tojson|safe }};
new Chart(agingCtx, {
    type: 'doughnut',
    data: {
        labels: chartLabels,
        datasets: [{
            data: chartAmounts,
            backgroundColor: [
                'rgba(34, 197, 94, 0.8)',  // green
                'rgba(234, 179, 8, 0.8)',   // yellow
                'rgba(249, 115, 22, 0.8)',  // orange
                'rgba(239, 68, 68, 0.8)'    // red
            ],
            borderColor: [
                'rgb(34, 197, 94)',
                'rgb(234, 179, 8)',
                'rgb(249, 115, 22)',
                'rgb(239, 68, 68)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': ' + context.parsed.toFixed(2) + ' €';
                    }
                }
            }
        }
    }
});

// Top Customers Chart
const topCustomersCtx = document.getElementById('topCustomersChart').getContext('2d');
const topCustomersLabels = {{ top_customers_chart.labels|tojson|safe }};
const topCustomersAmounts = {{ top_customers_chart.amounts|tojson|safe }};
const outstandingLabel = '{{ _("Outstanding Amount") }}';
new Chart(topCustomersCtx, {
    type: 'bar',
    data: {
        labels: topCustomersLabels,
        datasets: [{
            label: outstandingLabel,
            data: topCustomersAmounts,
            backgroundColor: 'rgba(99, 102, 241, 0.8)',
            borderColor: 'rgb(99, 102, 241)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.parsed.x.toFixed(2) + ' €';
                    }
                }
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value.toFixed(0) + ' €';
                    }
                }
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}


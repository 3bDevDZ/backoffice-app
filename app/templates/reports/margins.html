{% extends "base.html" %}

{% block title %}{{ _('Margin Report') }} - CommerceFlow{% endblock %}

{% block page_title %}{{ _('Margin Report') }}{% endblock %}
{% block page_subtitle %}{{ _('Profitability analysis by product and customer') }}{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<!-- Date Range Filter -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6" style="border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
    <form method="GET" action="{{ url_for('reports.margins_report') }}" class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <label class="block text-sm font-medium mb-2" style="color: var(--color-text-primary);">{{ _('Start Date') }}</label>
            <input type="date" name="start_date" value="{{ start_date }}" class="modern-input" required>
        </div>
        <div>
            <label class="block text-sm font-medium mb-2" style="color: var(--color-text-primary);">{{ _('End Date') }}</label>
            <input type="date" name="end_date" value="{{ end_date }}" class="modern-input" required>
        </div>
        <div>
            <label class="block text-sm font-medium mb-2" style="color: var(--color-text-primary);">{{ _('Min Margin %') }}</label>
            <input type="number" name="min_margin_percent" step="0.01" class="modern-input" placeholder="{{ _('Optional') }}">
        </div>
        <div class="flex items-end">
            <button type="submit" class="btn-primary w-full">
                <i class="fas fa-filter {% if direction == 'rtl' %}ml-2{% else %}mr-2{% endif %}"></i>
                {{ _('Apply Filters') }}
            </button>
        </div>
    </form>
</div>

<!-- Summary Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6" id="summary-cards">
    <div class="stat-card">
        <div class="stat-card-label">{{ _('Total Revenue') }}</div>
        <div class="stat-card-metric" style="color: var(--color-success);" id="total-revenue">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-card-label">{{ _('Total Cost') }}</div>
        <div class="stat-card-metric" style="color: var(--color-danger);" id="total-cost">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-card-label">{{ _('Total Margin') }}</div>
        <div class="stat-card-metric" style="color: var(--color-info);" id="total-margin">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-card-label">{{ _('Overall Margin %') }}</div>
        <div class="stat-card-metric" style="color: #7C3AED;" id="overall-margin-percent">-</div>
    </div>
</div>

<!-- Margin Chart -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6" style="border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold" style="color: var(--color-text-primary);">{{ _('Margin by Product') }}</h3>
        <div class="flex {% if direction == 'rtl' %}space-x-reverse space-x-2{% else %}space-x-2{% endif %}">
            <button onclick="exportReport('excel')" class="btn-secondary text-sm">
                <i class="fas fa-file-excel"></i>
            </button>
            <button onclick="exportReport('pdf')" class="btn-secondary text-sm">
                <i class="fas fa-file-pdf"></i>
            </button>
            <button onclick="exportReport('csv')" class="btn-secondary text-sm">
                <i class="fas fa-file-csv"></i>
            </button>
        </div>
    </div>
    <canvas id="margin-chart" height="100"></canvas>
</div>

<!-- Margin Table -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6" style="border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
    <h3 class="text-lg font-bold mb-4" style="color: var(--color-text-primary);">{{ _('Margin Details') }}</h3>
    <div class="overflow-x-auto">
        <table class="modern-table">
            <thead>
                <tr>
                    <th>{{ _('Product') }}</th>
                    <th class="text-right">{{ _('Quantity Sold') }}</th>
                    <th class="text-right">{{ _('Revenue') }}</th>
                    <th class="text-right">{{ _('Cost') }}</th>
                    <th class="text-right">{{ _('Margin') }}</th>
                    <th class="text-right">{{ _('Margin %') }}</th>
                </tr>
            </thead>
            <tbody id="margin-table">
                <tr><td colspan="6" class="text-center py-8" style="color: var(--color-text-tertiary);">{{ _('Loading...') }}</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
let marginChart;

async function loadReportData() {
    try {
        const params = new URLSearchParams({
            start_date: '{{ start_date }}',
            end_date: '{{ end_date }}'
        });
        
        const response = await fetch(`/reports/data/margins?${params}`);
        const result = await response.json();
        
        if (result.success && result.data) {
            const data = result.data;
            
            // Update summary cards
            document.getElementById('total-revenue').textContent = formatCurrencyValue(data.summary.total_revenue || 0);
            document.getElementById('total-cost').textContent = formatCurrencyValue(data.summary.total_cost || 0);
            document.getElementById('total-margin').textContent = formatCurrencyValue(data.summary.total_margin || 0);
            document.getElementById('overall-margin-percent').textContent = (data.summary.overall_margin_percent || 0).toFixed(2) + '%';
            
            // Update chart
            updateChart(data.data);
            
            // Update table
            const table = document.getElementById('margin-table');
            table.innerHTML = data.data.map(item => `
                <tr>
                    <td>${item.product_name || item.product_code}</td>
                    <td class="text-right">${item.quantity_sold || 0}</td>
                    <td class="text-right">${formatCurrencyValue(item.revenue || 0)}</td>
                    <td class="text-right">${formatCurrencyValue(item.cost || 0)}</td>
                    <td class="text-right" style="color: ${item.margin >= 0 ? 'var(--color-success)' : 'var(--color-danger)'}">
                        ${formatCurrencyValue(item.margin || 0)}
                    </td>
                    <td class="text-right" style="color: ${item.margin_percent >= 0 ? 'var(--color-success)' : 'var(--color-danger)'}">
                        ${(item.margin_percent || 0).toFixed(2)}%
                    </td>
                </tr>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading report data:', error);
    }
}

function updateChart(data) {
    if (!data || data.length === 0) {
        console.warn('No margin data available for chart');
        return;
    }
    
    const chartData = data.slice(0, 10);
    const products = chartData.map(d => d.product_name || d.product_code || '');
    const margins = chartData.map(d => {
        const val = parseFloat(d.margin) || 0;
        return isNaN(val) ? 0 : val;
    });
    
    const canvas = document.getElementById('margin-chart');
    if (!canvas) {
        console.error('Margin chart canvas not found');
        return;
    }
    
    const ctx = canvas.getContext('2d');
    if (marginChart) {
        marginChart.destroy();
        marginChart = null;
    }
    
    marginChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: products,
            datasets: [{
                label: '{{ _("Margin") }}',
                data: margins,
                backgroundColor: margins.map(m => m >= 0 ? 'rgba(34, 197, 94, 0.5)' : 'rgba(239, 68, 68, 0.5)'),
                borderColor: margins.map(m => m >= 0 ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)'),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            animation: {
                duration: 750
            },
            plugins: {
                legend: {
                    display: true
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y;
                            return formatCurrencyValue ? formatCurrencyValue(value) : value.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            if (typeof formatCurrencyValue === 'function') {
                                return formatCurrencyValue(value);
                            }
                            return value.toFixed(2);
                        },
                        maxTicksLimit: 10
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
}

async function exportReport(format) {
    try {
        const response = await fetch('/reports/export', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                report_type: 'margins',
                format: format,
                start_date: '{{ start_date }}',
                end_date: '{{ end_date }}'
            })
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `margin_report.${format === 'excel' ? 'xlsx' : format}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } else {
            alert('{{ _("Export failed") }}');
        }
    } catch (error) {
        console.error('Export error:', error);
        alert('{{ _("Export failed") }}');
    }
}

// Load data on page load (only once)
let dataLoaded = false;
document.addEventListener('DOMContentLoaded', function() {
    if (!dataLoaded) {
        dataLoaded = true;
        loadReportData();
    }
});
</script>
{% endblock %}


{% extends "base.html" %}

{% block title %}{% if price_list %}{{ _('Edit Price List') }}{% else %}{{ _('New Price List') }}{% endif %} - CommerceFlow{% endblock %}

{% block extra_css %}
{% if not price_list %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
    .select2-container {
        width: 100% !important;
    }
    .select2-container--default .select2-selection--single {
        height: 38px;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 36px;
        padding-left: 12px;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 36px;
    }
</style>
{% endif %}
{% endblock %}

{% block page_title %}{% if price_list %}{{ _('Edit Price List') }}{% else %}{{ _('New Price List') }}{% endif %}{% endblock %}
{% block page_subtitle %}{% if price_list %}{{ _('Modify price list information') }}{% else %}{{ _('Create a new price list for customer pricing') }}{% endif %}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <form method="POST" action="{{ url_for('products_frontend.save_price_list') }}">
        {% if price_list %}
        <input type="hidden" name="id" value="{{ price_list.id }}">
        {% endif %}
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6" style="border-radius: var(--radius-xl); box-shadow: var(--shadow-md);">
            <h3 class="text-lg font-bold mb-4" style="color: var(--color-text-primary);">{{ _('Price List Information') }}</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--color-text-secondary);">
                        {{ _('Name') }} <span style="color: var(--color-error);">*</span>
                    </label>
                    <input type="text" 
                           name="name" 
                           value="{% if price_list %}{{ price_list.name }}{% endif %}"
                           required
                           class="modern-input"
                           placeholder="{{ _('Ex: Premium Customers, Wholesale, Retail') }}">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--color-text-secondary);">
                        {{ _('Description') }}
                    </label>
                    <textarea rows="3" 
                              name="description" 
                              class="modern-input"
                              placeholder="{{ _('Optional description for this price list') }}">{% if price_list %}{{ price_list.description or '' }}{% endif %}</textarea>
                </div>
                
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" 
                               name="is_active" 
                               {% if price_list and price_list.is_active or not price_list %}checked{% endif %}
                               class="mr-2">
                        <span class="text-sm" style="color: var(--color-text-secondary);">{{ _('Active') }}</span>
                    </label>
                    <p class="text-xs mt-1" style="color: var(--color-text-tertiary);">
                        {{ _('Only active price lists can be assigned to customers') }}
                    </p>
                </div>
            </div>
        </div>
        
        {% if not price_list %}
        <!-- Products Section (only when creating new price list) -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6" style="border-radius: var(--radius-xl); box-shadow: var(--shadow-md);">
            <div class="flex {% if direction == 'rtl' %}justify-between{% else %}justify-between{% endif %} items-center mb-4">
                <h3 class="text-lg font-bold" style="color: var(--color-text-primary);">{{ _('Products & Prices') }}</h3>
                <button type="button" onclick="addProductLine()" class="btn-secondary">
                    <i class="fas fa-plus {% if direction == 'rtl' %}ml-2{% else %}mr-2{% endif %}"></i>
                    {{ _('Add Product') }}
                </button>
            </div>
            <p class="text-sm mb-4" style="color: var(--color-text-secondary);">
                {{ _('Add products and set their prices in this price list. You can also add products later.') }}
            </p>
            
            <div id="products-container" class="space-y-3">
                <!-- Product lines will be added here dynamically -->
            </div>
        </div>
        {% endif %}
        
        <!-- Form Actions -->
        <div class="flex {% if direction == 'rtl' %}justify-start{% else %}justify-end{% endif %} {% if direction == 'rtl' %}space-x-reverse space-x-3{% else %}space-x-3{% endif %}">
            <a href="{{ url_for('products_frontend.list_price_lists') }}" class="btn-secondary">
                <i class="fas fa-times {% if direction == 'rtl' %}ml-2{% else %}mr-2{% endif %}"></i>
                {{ _('Cancel') }}
            </a>
            <button type="submit" class="btn-primary">
                <i class="fas fa-check {% if direction == 'rtl' %}ml-2{% else %}mr-2{% endif %}"></i>
                {{ _('Save') }}
            </button>
        </div>
    </form>
    
    {% if price_list %}
    <!-- Products in Price List -->
    <div class="mt-8 bg-white rounded-xl shadow-sm border border-gray-100 p-6" style="border-radius: var(--radius-xl); box-shadow: var(--shadow-md);">
        <div class="flex {% if direction == 'rtl' %}justify-between{% else %}justify-between{% endif %} items-center mb-4">
            <h3 class="text-lg font-bold" style="color: var(--color-text-primary);">{{ _('Products in Price List') }}</h3>
            <a href="{{ url_for('products_frontend.list_products_in_price_list', price_list_id=price_list.id) }}" class="btn-secondary">
                <i class="fas fa-list"></i>
                <span>{{ _('Manage Products') }}</span>
            </a>
        </div>
        <p class="text-sm" style="color: var(--color-text-secondary);">
            {{ _('Add products and set their prices in this price list.') }}
        </p>
    </div>
    {% endif %}
</div>

{% if not price_list %}
<!-- jQuery and Select2 JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
let products = [];
let productLineIndex = 0;

// Load products from frontend route
async function loadProducts() {
    try {
        const response = await fetch('/price-lists/data/products');
        const data = await response.json();
        
        if (data.success && data.data && data.data.items) {
            products = data.data.items;
        } else {
            console.error('Error loading products:', data);
        }
    } catch (error) {
        console.error('Error loading products:', error);
    }
}

// Add a new product line
function addProductLine() {
    const container = document.getElementById('products-container');
    const lineDiv = document.createElement('div');
    lineDiv.className = 'product-line border border-gray-200 rounded-lg p-4';
    lineDiv.setAttribute('data-line-index', productLineIndex);
    
    lineDiv.innerHTML = `
        <div class="grid grid-cols-12 gap-4 items-end">
            <div class="col-span-6">
                <label class="block text-sm font-medium mb-2" style="color: var(--color-text-secondary);">
                    {{ _('Product') }} <span style="color: var(--color-error);">*</span>
                </label>
                <select name="products[${productLineIndex}][product_id]" required
                        class="product-select block w-full px-3 py-2 text-sm border border-gray-300 rounded-lg">
                    <option value="">{{ _('Select product...') }}</option>
                </select>
            </div>
            <div class="col-span-4">
                <label class="block text-sm font-medium mb-2" style="color: var(--color-text-secondary);">
                    {{ _('Price') }} <span style="color: var(--color-error);">*</span>
                </label>
                <input type="number" 
                       name="products[${productLineIndex}][price]" 
                       step="0.01" 
                       min="0" 
                       required
                       class="block w-full px-3 py-2 text-sm border border-gray-300 rounded-lg"
                       placeholder="0.00">
            </div>
            <div class="col-span-2">
                <button type="button" onclick="removeProductLine(this)" class="w-full px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg border border-red-200">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(lineDiv);
    
    // Populate product select
    const productSelect = lineDiv.querySelector('.product-select');
    products.forEach(product => {
        const option = document.createElement('option');
        option.value = product.id;
        option.textContent = `${product.code} - ${product.name}`;
        productSelect.appendChild(option);
    });
    
    // Initialize Select2
    if (typeof jQuery !== 'undefined' && typeof jQuery.fn.select2 !== 'undefined') {
        setTimeout(function() {
            if ($(productSelect).hasClass('select2-hidden-accessible')) {
                $(productSelect).select2('destroy');
            }
            $(productSelect).select2({
                theme: 'bootstrap-5',
                placeholder: '{{ _("Select product...") }}',
                allowClear: true,
                width: '100%'
            });
        }, 100);
    }
    
    productLineIndex++;
}

// Remove a product line
function removeProductLine(button) {
    const lineDiv = button.closest('.product-line');
    const productSelect = lineDiv.querySelector('.product-select');
    
    if (productSelect && typeof jQuery !== 'undefined' && typeof jQuery.fn.select2 !== 'undefined') {
        if ($(productSelect).hasClass('select2-hidden-accessible')) {
            $(productSelect).select2('destroy');
        }
    }
    
    lineDiv.remove();
}

// Load products on page load
document.addEventListener('DOMContentLoaded', function() {
    loadProducts();
});
</script>
{% endif %}
{% endblock %}


{% extends "base.html" %}

{% block title %}{{ product.name }} - {{ _('Product Details') }} - CommerceFlow{% endblock %}

{% block page_title %}{{ product.name }}{% endblock %}
{% block page_subtitle %}{{ product.code }} - {{ _('Product Details') }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Product Header -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6" style="border-radius: var(--radius-xl); box-shadow: var(--shadow-md);">
        <div class="flex {% if direction == 'rtl' %}justify-between{% else %}justify-between{% endif %} items-start">
            <div>
                <h2 class="text-2xl font-bold mb-2" style="color: var(--color-text-primary);">{{ product.name }}</h2>
                <p class="text-sm" style="color: var(--color-text-tertiary);">
                    <span class="font-medium">{{ _('Code') }}:</span> {{ product.code }}
                    {% if product.barcode %}
                    | <span class="font-medium">{{ _('Barcode') }}:</span> {{ product.barcode }}
                    {% endif %}
                </p>
            </div>
            <div class="flex {% if direction == 'rtl' %}space-x-reverse space-x-3{% else %}space-x-3{% endif %}">
                <a href="{{ url_for('products_frontend.edit', product_id=product.id) }}" class="btn-secondary">
                    <i class="fas fa-edit"></i>
                    <span>{{ _('Edit') }}</span>
                </a>
                <a href="{{ url_for('products_frontend.list') }}" class="btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    <span>{{ _('Back to List') }}</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6" style="border-radius: var(--radius-xl); box-shadow: var(--shadow-md);">
        <div class="border-b border-gray-200">
            <nav class="flex {% if direction == 'rtl' %}space-x-reverse space-x-8{% else %}space-x-8{% endif %}" aria-label="Tabs">
                <button onclick="showTab('details')" id="tab-details" class="tab-button active py-4 px-1 border-b-2 font-medium text-sm" style="border-color: var(--color-primary); color: var(--color-primary);">
                    {{ _('Details') }}
                </button>
                <button onclick="showTab('variants')" id="tab-variants" class="tab-button py-4 px-1 border-b-2 font-medium text-sm border-transparent" style="color: var(--color-text-secondary);">
                    {{ _('Variants') }} ({{ variants|length }})
                </button>
                <button onclick="showTab('price-history')" id="tab-price-history" class="tab-button py-4 px-1 border-b-2 font-medium text-sm border-transparent" style="color: var(--color-text-secondary);">
                    {{ _('Price History') }} ({{ price_history|length }})
                </button>
                <button onclick="showTab('cost-history')" id="tab-cost-history" class="tab-button py-4 px-1 border-b-2 font-medium text-sm border-transparent" style="color: var(--color-text-secondary);">
                    {{ _('Cost History') }} ({{ cost_history|length }})
                </button>
            </nav>
        </div>

        <!-- Tab Content: Details -->
        <div id="tab-content-details" class="tab-content p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold mb-4" style="color: var(--color-text-primary);">{{ _('Basic Information') }}</h3>
                    <dl class="space-y-3">
                        <div>
                            <dt class="text-sm font-medium" style="color: var(--color-text-tertiary);">{{ _('Name') }}</dt>
                            <dd class="mt-1 text-sm" style="color: var(--color-text-primary);">{{ product.name }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium" style="color: var(--color-text-tertiary);">{{ _('Code') }}</dt>
                            <dd class="mt-1 text-sm" style="color: var(--color-text-primary);">{{ product.code }}</dd>
                        </div>
                        {% if product.barcode %}
                        <div>
                            <dt class="text-sm font-medium" style="color: var(--color-text-tertiary);">{{ _('Barcode') }}</dt>
                            <dd class="mt-1 text-sm" style="color: var(--color-text-primary);">{{ product.barcode }}</dd>
                        </div>
                        {% endif %}
                        {% if product.description %}
                        <div>
                            <dt class="text-sm font-medium" style="color: var(--color-text-tertiary);">{{ _('Description') }}</dt>
                            <dd class="mt-1 text-sm" style="color: var(--color-text-primary);">{{ product.description }}</dd>
                        </div>
                        {% endif %}
                        <div>
                            <dt class="text-sm font-medium" style="color: var(--color-text-tertiary);">{{ _('Status') }}</dt>
                            <dd class="mt-1">
                                <span class="badge {% if product.status == 'active' %}badge-confirmed{% else %}badge-cancelled{% endif %}">
                                    {{ product.status|title }}
                                </span>
                            </dd>
                        </div>
                    </dl>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-4" style="color: var(--color-text-primary);">{{ _('Pricing') }}</h3>
                    <dl class="space-y-3">
                        <div>
                            <dt class="text-sm font-medium" style="color: var(--color-text-tertiary);">{{ _('Price') }}</dt>
                            <dd class="mt-1 text-sm font-semibold" style="color: var(--color-text-primary);">{{ "%.2f"|format(product.price) }} €</dd>
                        </div>
                        {% if product.cost %}
                        <div>
                            <dt class="text-sm font-medium" style="color: var(--color-text-tertiary);">{{ _('Cost') }}</dt>
                            <dd class="mt-1 text-sm" style="color: var(--color-text-primary);">{{ "%.2f"|format(product.cost) }} €</dd>
                        </div>
                        {% endif %}
                        {% if product.unit_of_measure %}
                        <div>
                            <dt class="text-sm font-medium" style="color: var(--color-text-tertiary);">{{ _('Unit of Measure') }}</dt>
                            <dd class="mt-1 text-sm" style="color: var(--color-text-primary);">{{ product.unit_of_measure }}</dd>
                        </div>
                        {% endif %}
                    </dl>
                </div>
            </div>
        </div>

        <!-- Tab Content: Variants -->
        <div id="tab-content-variants" class="tab-content p-6 hidden">
            <div class="flex {% if direction == 'rtl' %}justify-between{% else %}justify-between{% endif %} items-center mb-4">
                <h3 class="text-lg font-semibold" style="color: var(--color-text-primary);">{{ _('Product Variants') }}</h3>
                <a href="{{ url_for('products_frontend.new_variant', product_id=product.id) }}" class="btn-primary">
                    <i class="fas fa-plus"></i>
                    <span>{{ _('Add Variant') }}</span>
                </a>
            </div>

            {% if variants %}
            <div class="modern-table-container">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>{{ _('Code') }}</th>
                            <th>{{ _('Name') }}</th>
                            <th>{{ _('Attributes') }}</th>
                            <th>{{ _('Price') }}</th>
                            <th>{{ _('Cost') }}</th>
                            <th>{{ _('Barcode') }}</th>
                            <th>{{ _('Status') }}</th>
                            <th>{{ _('Actions') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for variant in variants %}
                        <tr>
                            <td>{{ variant.code }}</td>
                            <td>{{ variant.name }}</td>
                            <td>
                                {% if variant.attributes %}
                                {% set attrs = variant.attributes|from_json if variant.attributes else {} %}
                                <div class="flex flex-wrap gap-1">
                                    {% for key, value in attrs.items() %}
                                    <span class="text-xs px-2 py-1 rounded" style="background: var(--color-bg-tertiary); color: var(--color-text-secondary);">
                                        <strong>{{ key }}:</strong> {{ value }}
                                    </span>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <span class="text-gray-400 text-xs">{{ _('No attributes') }}</span>
                                {% endif %}
                            </td>
                            <td>{{ "%.2f"|format(variant.price) if variant.price else _('N/A') }} €</td>
                            <td>{{ "%.2f"|format(variant.cost) if variant.cost else _('N/A') }} €</td>
                            <td>{{ variant.barcode or _('N/A') }}</td>
                            <td>
                                <span class="badge {% if variant.status == 'active' %}badge-confirmed{% else %}badge-cancelled{% endif %}">
                                    {{ variant.status|title }}
                                </span>
                            </td>
                            <td>
                                <div class="flex {% if direction == 'rtl' %}space-x-reverse space-x-2{% else %}space-x-2{% endif %}">
                                    <a href="{{ url_for('products_frontend.edit_variant', variant_id=variant.id) }}" 
                                       class="text-indigo-600 hover:text-indigo-900" title="{{ _('Edit') }}">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% if variant.status == 'active' %}
                                    <form method="POST" action="{{ url_for('products_frontend.archive_variant', variant_id=variant.id) }}" class="inline">
                                        <button type="submit" class="text-yellow-600 hover:text-yellow-900" title="{{ _('Archive') }}" onclick="return confirm('{{ _('Are you sure you want to archive this variant?') }}')">
                                            <i class="fas fa-archive"></i>
                                        </button>
                                    </form>
                                    {% else %}
                                    <form method="POST" action="{{ url_for('products_frontend.activate_variant', variant_id=variant.id) }}" class="inline">
                                        <button type="submit" class="text-green-600 hover:text-green-900" title="{{ _('Activate') }}">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                    <form method="POST" action="{{ url_for('products_frontend.delete_variant', variant_id=variant.id) }}" class="inline">
                                        <button type="submit" class="text-red-600 hover:text-red-900" title="{{ _('Delete') }}" onclick="return confirm('{{ _('Are you sure you want to delete this variant?') }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-12">
                <i class="fas fa-box-open text-4xl mb-4" style="color: var(--color-text-tertiary);"></i>
                <p class="text-gray-500 mb-4">{{ _('No variants found for this product.') }}</p>
                <a href="{{ url_for('products_frontend.new_variant', product_id=product.id) }}" class="btn-primary">
                    <i class="fas fa-plus"></i>
                    <span>{{ _('Add First Variant') }}</span>
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Tab Content: Price History -->
        <div id="tab-content-price-history" class="tab-content p-6 hidden">
            <h3 class="text-lg font-semibold mb-4" style="color: var(--color-text-primary);">{{ _('Price History') }}</h3>
            
            {% if price_history %}
            <div class="modern-table-container">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th class="text-{% if direction == 'rtl' %}right{% else %}left{% endif %}">{{ _('Date') }}</th>
                            <th class="text-{% if direction == 'rtl' %}right{% else %}left{% endif %}">{{ _('Old Price') }}</th>
                            <th class="text-{% if direction == 'rtl' %}right{% else %}left{% endif %}">{{ _('New Price') }}</th>
                            <th class="text-{% if direction == 'rtl' %}right{% else %}left{% endif %}">{{ _('Change') }}</th>
                            <th class="text-{% if direction == 'rtl' %}right{% else %}left{% endif %}">{{ _('Changed By') }}</th>
                            <th class="text-{% if direction == 'rtl' %}right{% else %}left{% endif %}">{{ _('Reason') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in price_history %}
                        <tr>
                            <td>{{ entry.changed_at.strftime('%Y-%m-%d %H:%M') if entry.changed_at else '-' }}</td>
                            <td>
                                {% if entry.old_price %}
                                <span class="text-gray-600">{{ "%.2f"|format(entry.old_price) }} €</span>
                                {% else %}
                                <span class="text-gray-400 italic">{{ _('Initial Price') }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="font-semibold" style="color: var(--color-text-primary);">{{ "%.2f"|format(entry.new_price) }} €</span>
                            </td>
                            <td>
                                {% if entry.old_price %}
                                {% set change = entry.new_price - entry.old_price %}
                                {% set change_percent = (change / entry.old_price * 100) if entry.old_price > 0 else 0 %}
                                <span class="{% if change > 0 %}text-red-600{% elif change < 0 %}text-green-600{% else %}text-gray-500{% endif %}">
                                    {% if change > 0 %}+{% endif %}{{ "%.2f"|format(change) }} €
                                    ({% if change_percent > 0 %}+{% endif %}{{ "%.1f"|format(change_percent) }}%)
                                </span>
                                {% else %}
                                <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="text-sm" style="color: var(--color-text-secondary);">
                                    {{ entry.changed_by_username or _('System') }}
                                </span>
                            </td>
                            <td>
                                <span class="text-sm" style="color: var(--color-text-tertiary);">
                                    {{ entry.reason or '-' }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-12">
                <i class="fas fa-chart-line text-4xl mb-4" style="color: var(--color-text-tertiary);"></i>
                <p class="text-gray-500 mb-4">{{ _('No price history available for this product.') }}</p>
                <p class="text-sm text-gray-400">{{ _('Price changes will be tracked automatically when the product price is updated.') }}</p>
            </div>
            {% endif %}
        </div>

        <!-- Tab Content: Cost History -->
        <div id="tab-content-cost-history" class="tab-content p-6 hidden">
            <h3 class="text-lg font-semibold mb-4" style="color: var(--color-text-primary);">{{ _('Cost History') }} (AVCO)</h3>
            
            {% if cost_history %}
            <div class="modern-table-container">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th class="text-{% if direction == 'rtl' %}right{% else %}left{% endif %}">{{ _('Date') }}</th>
                            <th class="text-{% if direction == 'rtl' %}right{% else %}left{% endif %}">{{ _('Old Cost') }}</th>
                            <th class="text-{% if direction == 'rtl' %}right{% else %}left{% endif %}">{{ _('New Cost') }}</th>
                            <th class="text-{% if direction == 'rtl' %}right{% else %}left{% endif %}">{{ _('Change') }}</th>
                            <th class="text-{% if direction == 'rtl' %}right{% else %}left{% endif %}">{{ _('Purchase Price') }}</th>
                            <th class="text-{% if direction == 'rtl' %}right{% else %}left{% endif %}">{{ _('Qty Received') }}</th>
                            <th class="text-{% if direction == 'rtl' %}right{% else %}left{% endif %}">{{ _('Stock Before') }}</th>
                            <th class="text-{% if direction == 'rtl' %}right{% else %}left{% endif %}">{{ _('Stock After') }}</th>
                            <th class="text-{% if direction == 'rtl' %}right{% else %}left{% endif %}">{{ _('Changed By') }}</th>
                            <th class="text-{% if direction == 'rtl' %}right{% else %}left{% endif %}">{{ _('Reason') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in cost_history %}
                        <tr>
                            <td>{{ entry.changed_at.strftime('%Y-%m-%d %H:%M') if entry.changed_at else '-' }}</td>
                            <td>
                                {% if entry.old_cost %}
                                <span class="text-gray-600">{{ "%.2f"|format(entry.old_cost) }} €</span>
                                {% else %}
                                <span class="text-gray-400 italic">{{ _('Initial Cost') }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="font-semibold" style="color: var(--color-text-primary);">{{ "%.2f"|format(entry.new_cost) }} €</span>
                            </td>
                            <td>
                                {% if entry.old_cost %}
                                {% set change = entry.new_cost - entry.old_cost %}
                                {% set change_percent = (change / entry.old_cost * 100) if entry.old_cost > 0 else 0 %}
                                <span class="{% if change > 0 %}text-red-600{% elif change < 0 %}text-green-600{% else %}text-gray-500{% endif %}">
                                    {% if change > 0 %}+{% endif %}{{ "%.2f"|format(change) }} €
                                    ({% if change_percent > 0 %}+{% endif %}{{ "%.1f"|format(change_percent) }}%)
                                </span>
                                {% else %}
                                <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="text-sm" style="color: var(--color-text-secondary);">
                                    {{ "%.2f"|format(entry.purchase_price) }} €
                                </span>
                            </td>
                            <td>
                                <span class="text-sm" style="color: var(--color-text-secondary);">
                                    {{ "%.3f"|format(entry.quantity_received) }}
                                </span>
                            </td>
                            <td>
                                <span class="text-sm" style="color: var(--color-text-tertiary);">
                                    {{ "%.3f"|format(entry.old_stock) if entry.old_stock else '0.000' }}
                                </span>
                            </td>
                            <td>
                                <span class="text-sm" style="color: var(--color-text-tertiary);">
                                    {{ "%.3f"|format(entry.new_stock) }}
                                </span>
                            </td>
                            <td>
                                <span class="text-sm" style="color: var(--color-text-secondary);">
                                    {{ entry.changed_by_username or _('System') }}
                                </span>
                            </td>
                            <td>
                                <span class="text-sm" style="color: var(--color-text-tertiary);">
                                    {{ entry.reason or '-' }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-12">
                <i class="fas fa-calculator text-4xl mb-4" style="color: var(--color-text-tertiary);"></i>
                <p class="text-gray-500 mb-4">{{ _('No cost history available for this product.') }}</p>
                <p class="text-sm text-gray-400">{{ _('Cost changes will be tracked automatically when purchase orders are received (AVCO method).') }}</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
        button.style.borderColor = 'transparent';
        button.style.color = 'var(--color-text-secondary)';
    });
    
    // Show selected tab content
    document.getElementById('tab-content-' + tabName).classList.remove('hidden');
    
    // Add active class to selected tab
    const activeTab = document.getElementById('tab-' + tabName);
    activeTab.classList.add('active');
    activeTab.style.borderColor = 'var(--color-primary)';
    activeTab.style.color = 'var(--color-primary)';
}
</script>
{% endblock %}


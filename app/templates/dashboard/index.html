{% extends "base.html" %}

{% block title %}{{ _('Dashboard') }} - CommerceFlow{% endblock %}

{% block page_title %}{{ _('Dashboard') }}{% endblock %}
{% block page_subtitle %}{{ _('Overview of your business activity') }}{% endblock %}

{% block content %}
<!-- KPI Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Revenue -->
    <div class="stat-card stat-card-received">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background: var(--color-success-light);">
                <i class="fas fa-euro-sign text-xl" style="color: var(--color-success);"></i>
            </div>
            <span class="badge badge-received" style="font-size: 0.625rem; padding: 0.25rem 0.5rem;">
                <i class="fas fa-arrow-up {% if direction == 'rtl' %}ml-1{% else %}mr-1{% endif %}"></i>
                +12.5%
            </span>
        </div>
        <div class="stat-card-label">{{ _('Total Revenue') }}</div>
        <div class="stat-card-metric" style="color: var(--color-success);" id="total-revenue">{{ 0|currency }}</div>
        <div class="text-xs mt-2" style="color: var(--color-text-tertiary);">{{ _('This month') }}</div>
    </div>

    <!-- Total Orders -->
    <div class="stat-card stat-card-confirmed">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background: var(--color-info-light);">
                <i class="fas fa-shopping-cart text-xl" style="color: var(--color-info);"></i>
            </div>
            <span class="badge badge-confirmed" style="font-size: 0.625rem; padding: 0.25rem 0.5rem;">
                <i class="fas fa-arrow-up {% if direction == 'rtl' %}ml-1{% else %}mr-1{% endif %}"></i>
                +8.2%
            </span>
        </div>
        <div class="stat-card-label">{{ _('Total Orders') }}</div>
        <div class="stat-card-metric" style="color: var(--color-info);" id="total-orders">0</div>
        <div class="text-xs mt-2" style="color: var(--color-text-tertiary);">{{ _('This month') }}</div>
    </div>

    <!-- Active Customers -->
    <div class="stat-card">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background: #F3E8FF;">
                <i class="fas fa-users text-xl" style="color: #7C3AED;"></i>
            </div>
            <span class="badge badge-partially_received" style="font-size: 0.625rem; padding: 0.25rem 0.5rem;">
                <i class="fas fa-arrow-up {% if direction == 'rtl' %}ml-1{% else %}mr-1{% endif %}"></i>
                +5.1%
            </span>
        </div>
        <div class="stat-card-label">{{ _('Active Customers') }}</div>
        <div class="stat-card-metric" style="color: #7C3AED;" id="active-customers">0</div>
        <div class="text-xs mt-2" style="color: var(--color-text-tertiary);">{{ _('Total') }}</div>
    </div>

    <!-- Products in Stock -->
    <div class="stat-card stat-card-draft">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background: var(--color-warning-light);">
                <i class="fas fa-box text-xl" style="color: var(--color-warning);"></i>
            </div>
            <span class="badge badge-draft" style="font-size: 0.625rem; padding: 0.25rem 0.5rem;">
                <i class="fas fa-minus {% if direction == 'rtl' %}ml-1{% else %}mr-1{% endif %}"></i>
                0%
            </span>
        </div>
        <div class="stat-card-label">{{ _('Products in Stock') }}</div>
        <div class="stat-card-metric" style="color: var(--color-warning);" id="products-stock">0</div>
        <div class="text-xs mt-2" style="color: var(--color-text-tertiary);">{{ _('Active products') }}</div>
    </div>
</div>

<!-- Charts Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Revenue Chart -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6" style="border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold" style="color: var(--color-text-primary);">{{ _('Revenue Trend') }}</h3>
            <select class="modern-select text-sm" style="width: auto; padding: 0.5rem 0.75rem;">
                <option>{{ _('Last 7 days') }}</option>
                <option>{{ _('Last 30 days') }}</option>
                <option>{{ _('Last 3 months') }}</option>
            </select>
        </div>
        <div class="h-64 flex items-center justify-center text-gray-400">
            <div class="text-center">
                <i class="fas fa-chart-line text-4xl mb-2"></i>
                <p>{{ _('Chart will be displayed here') }}</p>
            </div>
        </div>
    </div>

    <!-- Orders Chart -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6" style="border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold" style="color: var(--color-text-primary);">{{ _('Orders Trend') }}</h3>
            <select class="modern-select text-sm" style="width: auto; padding: 0.5rem 0.75rem;">
                <option>{{ _('Last 7 days') }}</option>
                <option>{{ _('Last 30 days') }}</option>
                <option>{{ _('Last 3 months') }}</option>
            </select>
        </div>
        <div class="h-64 flex items-center justify-center text-gray-400">
            <div class="text-center">
                <i class="fas fa-chart-bar text-4xl mb-2"></i>
                <p>{{ _('Chart will be displayed here') }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity & Quick Actions -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Recent Orders -->
    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-6" style="border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold" style="color: var(--color-text-primary);">{{ _('Recent Orders') }}</h3>
            <a href="{{ url_for('sales.orders_list') }}" class="text-sm font-medium transition-colors" style="color: var(--color-primary);" onmouseover="this.style.color='#4338CA'" onmouseout="this.style.color='var(--color-primary)'">
                {{ _('View all') }} <i class="fas fa-arrow-{% if direction == 'rtl' %}left{% else %}right{% endif %} {% if direction == 'rtl' %}mr-1{% else %}ml-1{% endif %}"></i>
            </a>
        </div>
        <div class="space-y-4">
            <div class="text-center py-8 text-gray-400">
                <i class="fas fa-shopping-cart text-3xl mb-2"></i>
                <p>{{ _('No recent orders') }}</p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6" style="border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
        <h3 class="text-lg font-bold mb-4" style="color: var(--color-text-primary);">{{ _('Quick Actions') }}</h3>
        <div class="space-y-3">
            <a href="{{ url_for('products_frontend.new') }}" class="flex items-center p-3 rounded-lg transition-all duration-200" style="background: rgba(79, 70, 229, 0.1); color: var(--color-primary);" onmouseover="this.style.background='rgba(79, 70, 229, 0.15)'; this.style.transform='translateX(4px)'" onmouseout="this.style.background='rgba(79, 70, 229, 0.1)'; this.style.transform='translateX(0)'">
                <i class="fas fa-plus w-5 {% if direction == 'rtl' %}ml-3{% else %}mr-3{% endif %}"></i>
                <span>{{ _('New Product') }}</span>
            </a>
            <a href="{{ url_for('customers_frontend.new') }}" class="flex items-center p-3 rounded-lg transition-all duration-200" style="background: rgba(59, 130, 246, 0.1); color: var(--color-info);" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'; this.style.transform='translateX(4px)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.1)'; this.style.transform='translateX(0)'">
                <i class="fas fa-user-plus w-5 {% if direction == 'rtl' %}ml-3{% else %}mr-3{% endif %}"></i>
                <span>{{ _('New Customer') }}</span>
            </a>
            <a href="{{ url_for('sales.create_quote') }}" class="flex items-center p-3 rounded-lg transition-all duration-200" style="background: rgba(124, 58, 237, 0.1); color: #7C3AED;" onmouseover="this.style.background='rgba(124, 58, 237, 0.15)'; this.style.transform='translateX(4px)'" onmouseout="this.style.background='rgba(124, 58, 237, 0.1)'; this.style.transform='translateX(0)'">
                <i class="fas fa-file-invoice w-5 {% if direction == 'rtl' %}ml-3{% else %}mr-3{% endif %}"></i>
                <span>{{ _('New Quote') }}</span>
            </a>
            <a href="{{ url_for('sales.create_order') }}" class="flex items-center p-3 rounded-lg transition-all duration-200" style="background: rgba(16, 185, 129, 0.1); color: var(--color-success);" onmouseover="this.style.background='rgba(16, 185, 129, 0.15)'; this.style.transform='translateX(4px)'" onmouseout="this.style.background='rgba(16, 185, 129, 0.1)'; this.style.transform='translateX(0)'">
                <i class="fas fa-shopping-cart w-5 {% if direction == 'rtl' %}ml-3{% else %}mr-3{% endif %}"></i>
                <span>{{ _('New Order') }}</span>
            </a>
            <a href="{{ url_for('stock.index') }}" class="flex items-center p-3 rounded-lg transition-all duration-200" style="background: rgba(245, 158, 11, 0.1); color: var(--color-warning);" onmouseover="this.style.background='rgba(245, 158, 11, 0.15)'; this.style.transform='translateX(4px)'" onmouseout="this.style.background='rgba(245, 158, 11, 0.1)'; this.style.transform='translateX(0)'">
                <i class="fas fa-warehouse w-5 {% if direction == 'rtl' %}ml-3{% else %}mr-3{% endif %}"></i>
                <span>{{ _('Stock Management') }}</span>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Format currency using configured currency
function formatCurrency(value) {
    const currency = window.appConfig?.currency || 'EUR';
    const locale = window.appConfig?.locale || '{{ locale }}';
    const localeMap = {
        'en': 'en-US',
        'fr': 'fr-FR',
        'ar': 'ar-DZ'
    };
    const intlLocale = localeMap[locale] || locale;
    
    return new Intl.NumberFormat(intlLocale, {
        style: 'currency',
        currency: currency,
        minimumFractionDigits: 2
    }).format(value);
}

// Format number
function formatNumber(value) {
    return new Intl.NumberFormat('{{ locale }}').format(value);
}

// Format percent
function formatPercent(value) {
    if (value === null || value === undefined) return '0%';
    const sign = value >= 0 ? '+' : '';
    return `${sign}${value.toFixed(1)}%`;
}

// Load dashboard data
async function loadDashboardData() {
    try {
        const response = await fetch('/dashboard/data/kpi?period=month');
        const result = await response.json();
        
        if (result.success && result.data) {
            const data = result.data;
            
            // Update revenue
            const revenueEl = document.getElementById('total-revenue');
            if (revenueEl) {
                revenueEl.textContent = formatCurrency(data.total_revenue);
            }
            
            // Update revenue change badge
            const revenueBadge = revenueEl?.parentElement?.querySelector('.badge');
            if (revenueBadge && data.revenue_change_percent !== null) {
                revenueBadge.innerHTML = `
                    <i class="fas fa-arrow-${data.revenue_change_percent >= 0 ? 'up' : 'down'} {% if direction == 'rtl' %}ml-1{% else %}mr-1{% endif %}"></i>
                    ${formatPercent(data.revenue_change_percent)}
                `;
            }
            
            // Update orders
            const ordersEl = document.getElementById('total-orders');
            if (ordersEl) {
                ordersEl.textContent = formatNumber(data.total_orders);
            }
            
            // Update orders change badge
            const ordersBadge = ordersEl?.parentElement?.querySelector('.badge');
            if (ordersBadge && data.orders_change_percent !== null) {
                ordersBadge.innerHTML = `
                    <i class="fas fa-arrow-${data.orders_change_percent >= 0 ? 'up' : 'down'} {% if direction == 'rtl' %}ml-1{% else %}mr-1{% endif %}"></i>
                    ${formatPercent(data.orders_change_percent)}
                `;
            }
            
            // Update active customers
            const customersEl = document.getElementById('active-customers');
            if (customersEl) {
                customersEl.textContent = formatNumber(data.active_customers);
            }
            
            // Update products in stock
            const productsEl = document.getElementById('products-stock');
            if (productsEl) {
                productsEl.textContent = formatNumber(data.products_in_stock);
            }
        } else {
            console.error('Error loading dashboard data:', result.message);
        }
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

// Load data on page load
loadDashboardData();

// Auto-refresh every 30 seconds
setInterval(loadDashboardData, 30000);
</script>
{% endblock %}

